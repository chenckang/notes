# 代理

## 代理的分类

可分为公共代理以及私有代理，大多数代理都是公用代理，因为集中式的代理成本相对较低，且更容易管理。

公共代理诸如高速缓存代理，利用大量用户的共同请求来实现网络节省。

对客户端来说代理扮演的是服务器，用于响应用户的请求。对于服务端来说代理充当客户端，用于代表真正的客户端向服务器发送请求。

## 代理和网关

代理连接的是使用两个及多个使用同一个协议的应用，而网关连接的是两个及多个不同协议的应用。例如，HTTP/POP网关将HTTP协议转换为POP协议并与EMAIL服务器通信。

但是很多情况下，代理和网关的界定也是模糊的，代理也有时候来实现协议转换，例如转换不同http版本、支持SSL等

## 代理所充当的作用

* 针对儿童的内容代理
* 访问权限控制
* 安全防火墙，限制数据流入流出，流量过滤等
* web缓存
* 反向代理，接受web服务器的真实请求，但是可以按章需求来发起其他服务器的通信。通过反向代理可以提高访问慢速web服务器上公共内容的性能。

## 代理的部署

* 出口代理，将代理固定在本地网络的出口处，提供内容屏蔽，安全防火墙等，例如学校部署代理来屏蔽成人内容
* ISP代理，部署在ISP的节点上，用于提供缓存等功能
* 反向代理，部署在在线服务器的边缘中，必要时向慢速的服务器发送请求。同时反向代理会充当服务器，用户访问的也是反向代理的域名和端口。


## 显示的代理请求和普通的web请求

### 显示的代理请求

相对于普通的web请求，显示的代理请求中URI部分为完整的URL。

如下：

    GET http://host/path/to/service/ HTTP/1.1
    User-Agent: xxx

这是由于在原始的HTTP设计中，并不存在虚拟主机，为了避免发送冗余信息，host及port都不会被发送，因而客户端发送请求时使用完整的URI。

浏览器中如果显示的配置了代理服务器，则会使用完整的URI。

### 代理需具备同时处理两种请求的能力

很多情况下客户端并不知道自己在和代理通信，因而代理服务器应该具备处理两种请求的能力。

处理策略如下：

* 如果请求提供完整的URI则使用完整的URI
* 如果提供的是部分URI且有Host首部，则使用Host首部来确定原始服务器IP及端口
* 如果提供部分URI但是没有Host首部
    * 如果代理是反向代理，则可以用真实的服务器IP和端口
    * 如果请求被拦截，且拦截代理可以提供服务器IP及端口，则使用之
    * 如果都失败，则返回错误消息，提示用户升级到支持Host的现代浏览器

## 报文追踪

各种代理由设备由不同的厂商生产，且由不同的组织维护，一个请求可能会经过一个或者多个的代理，对代理进行追踪有利于问题排查。

### Via首部

例如：

    Via: 1.1 a.com, 1.0 b.com

代表请求经过两个代理，a.com实现HTTP/1.1协议，b.com实现HTTP/1.0协议。

Via首部主要用于检测报文循环、记录报文转发及检测代理协议能力等。
其格式为使用逗号来依次分隔请求过程中经过的代理或者网关。

    Via: [protocal-name/]protocal-version (host[:port])|pseudonym {, ViaSegment}*

### Trace方法

用户可以通过Trace方法来追踪请求传输过程中所经过的代理，当Trace请求到达服务器时，服务器会将***请求报文***作为响应实体部分回送给客户端，请求所经历的代理列表在响应实体的Via部分中，响应的Content-Type为message/http, 状态为200 OK。

通过Max-Forwards首部可以限制Trace及Options方法所经历的最大请求跳数。代理接收到含Max-Forwards首部的请求是，在转发给下一跳前将Max-Forwards数减1，然后转发请求。

## 代理认证

相关的HTTP内容为，Proxy-Authenticate首部、407 Proxy Authorization Required状态码

其中 Proxy-Authenticate首部在请求报文中用于存储认证信息，例如

    Get Path/to/ HTTP/1.1
    Proxy-Authenticate: Basic xxxxx

在响应报文中用于存储认证内容，客户端接到响应后寻找认证内容（证书或者弹框）例如
    HTTP/1.1 200 OK
    Proxy-Authenticate: Basic realm="xxx"

## Options与Allow首部

Options用于探测服务器所支持的方法，例如：

    Options * HTTP/1.1

探测服务器的所有的服务所支持的方法，‘*’代表探所有的服务器服务。
如果是一个普通URI，则只探测该URI所支持的对应的方法。

Allow首部列出了服务器对请求的URI所支持的方法列表。如下：

    Allow: Get, Post, Head


